<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      function full_convo(s3_file) {
        $.ajax({
          type: "POST",
          url: "https://7pickqr2ub.execute-api.ap-southeast-2.amazonaws.com/prod/search?s3_file=" + s3_file,
          success: function(data) {
            let conversation = JSON.parse(JSON.stringify(data))["text"];
            let searchResultsDiv = $("#search-results");
            searchResultsDiv.empty();
            let messages = conversation.split("--------------------------");
            for (let i = 0; i < messages.length; i++) {
              let message = messages[i];
              let messageContainer = $("<div>", { class: "message-container" });
              let messageDiv = $("<div>", { class: "message" });
              let messageContent = $("<div>", { class: "message-content", text: message });
              messageDiv.append(messageContent);
              messageContainer.append(messageDiv);
              searchResultsDiv.append(messageContainer);
            }
          },
          error: function(xhr, status, error) {
            console.log(xhr);
            console.log(status);
            console.log(error);
          }
        });
      }
      
      function search() {
        var query = $("#search-box").val();
        $.ajax({
          type: "POST",
          url: "https://7pickqr2ub.execute-api.ap-southeast-2.amazonaws.com/prod/search?q=" + query,
          success: function(data) {
            let conversations = JSON.parse(JSON.stringify(data));
            let searchResultsDiv = $("#search-results");
            console.log(conversations.length)
            searchResultsDiv.empty();
            for (let conv_i = 0; conv_i < conversations.length; conv_i++){
              console.log(conversations);
              let conversation = conversations[conv_i]["text"];
              let messages = conversation.split("--------------------------");
    
              for (let i = 0; i < messages.length; i++) {
                let message = messages[i];
                let messageContainer = $("<div>", { class: "message-container" });
                let messageDiv = $("<div>", { class: "message" });
                let messageContent = $("<div>", { class: "message-content", text: message });
                messageDiv.append(messageContent);
                messageContainer.append(messageDiv);
                searchResultsDiv.append(messageContainer);
              }
              searchResultsDiv.append(
                '<div><a href="#" onclick=full_convo("' + conversations[conv_i]["full_convo_s3_key"] + '");>Full conversation</a></div>'
              )
              searchResultsDiv.append('<div class="group-separator">')
              searchResultsDiv.append("</div></br></br>")
            }
          },
          error: function(xhr, status, error) {
            console.log(xhr);
            console.log(status);
            console.log(error);
          }
        });
      }
    </script>
  </head>
  <body>
    <div class="header">
      <h1>Chat<span class="highlight">Overflow</span></h1>
      <p>Find the answers you need to your coding questions</p>
    </div>
    <div class="search-container">
      <input type="text" id="search-box" placeholder="Enter your search query" autofocus>
      <button class="button" onclick="search()">Search</button>
        <a class="button" href="https://chatoverflow.retool.com/embedded/public/f07fa3a5-8f91-4011-8d7f-1217d4a79ee6">Upload your conversation</a>
      </form>    
    </div>
    <div id="search-results"></div>
  <script>
    function changeLabel(){
      var input = document.getElementById("file-input");
      var label = document.getElementById("label-file-input");
      label.innerHTML = input.files[0].name;
    }
    document.getElementById("search-box").addEventListener("keyup", function(event) {
      event.preventDefault();
      if (event.keyCode === 13) {
        search();
      }
    });
  </script>
  </body>
</html>
